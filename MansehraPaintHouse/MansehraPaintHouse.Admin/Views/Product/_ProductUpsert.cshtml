@model MansehraPaintHouse.Core.Entities.Product

<form id="productForm" asp-action="ProductUpsert" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="ProductID" />
    <input type="hidden" asp-for="IsVariationProduct" id="isVariationProduct" />

    <div class="container-fluid p-3">
        <div class="row g-3">
            <div class="col-md-12">
                <div class="mb-3">
                    <label asp-for="Name" class="form-label required"></label>
                    <input asp-for="Name" class="form-control" placeholder="Enter product name" />
                    <span asp-validation-for="Name" class="text-danger small"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="CategoryID" class="form-label required"></label>
                    <select asp-for="CategoryID" class="form-select" asp-items="@(new SelectList(ViewBag.Categories, "CategoryID", "Name"))">
                        <option value="">-- Select Category --</option>
                    </select>
                    <span asp-validation-for="CategoryID" class="text-danger small"></span>
                </div>

                @*  <div class="mb-3">
                    <label class="form-label required">Product Type</label>
                    <select id="productType" class="form-select">
                        <option value="normal" @(!Model.IsVariationProduct ? "selected" : "")>Normal Product</option>
                        <option value="variation" @(Model.IsVariationProduct ? "selected" : "")>Variation Product</option>
                    </select>
                </div>  *@

                <div class="mb-3">
                    <label class="form-label required" for="productType">Product Type</label>
                    <select id="productType" class="form-select">
                        <option value="normal" selected="@(Model != null && !Model.IsVariationProduct)">Normal Product</option>
                        <option value="variation" selected="@(Model != null && Model.IsVariationProduct)">Variation Product</option>
                    </select>
                </div>

                <div id="normalProductFields" style="display: @(!Model.IsVariationProduct ? "block" : "none");">
                    <div class="mb-3">
                        <label asp-for="Description" class="form-label required"></label>
                        <textarea asp-for="Description" class="form-control" rows="3" placeholder="Enter description"></textarea>
                        <span asp-validation-for="Description" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="SKU" class="form-label required"></label>
                        <input asp-for="SKU" class="form-control" placeholder="Enter SKU" />
                        <span asp-validation-for="SKU" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Price" class="form-label required"></label>
                        <input asp-for="Price" class="form-control" type="number" step="0.01" placeholder="Enter price" />
                        <span asp-validation-for="Price" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="StockQuantity" class="form-label required"></label>
                        <input asp-for="StockQuantity" class="form-control" type="number" placeholder="Enter stock quantity" />
                        <span asp-validation-for="StockQuantity" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="MinimumStockLevel" class="form-label required"></label>
                        <input asp-for="MinimumStockLevel" class="form-control" type="number" placeholder="Enter minimum stock level" />
                        <span asp-validation-for="MinimumStockLevel" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Product Image</label>
                        <input type="file" name="imageFile" class="form-control" accept="image/*" />
                    </div>
                </div>

                <div id="variationProductFields" style="display: @(Model.IsVariationProduct ? "block" : "none");">
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" id="addVariationBtn">
                            <i class="bi bi-plus-circle"></i> Add Variation
                        </button>
                    </div>

                    <div id="variationsContainer">
                        <!-- Variations will be added here dynamically -->
                    </div>

                    <div id="variationsPreview" class="mt-3">
                        <h5>Variations Preview</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered" id="variationsTable">
                                <thead>
                                    <tr>
                                        <th>Attribute</th>
                                        <th>Value</th>
                                        <th>Price</th>
                                        <th>Stock</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Variation rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                        <label asp-for="IsActive" class="form-check-label"></label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary">Save</button>
    </div>
</form>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Handle product type change
            $('#productType').change(function () {
                var type = $(this).val();
                $('#isVariationProduct').val(type === 'variation');
                if (type === 'normal') {
                    $('#normalProductFields').show();
                    $('#variationProductFields').hide();
                } else {
                    $('#normalProductFields').hide();
                    $('#variationProductFields').show();
                }
            });

            // Handle add variation button click
            $('#addVariationBtn').click(function () {
                addVariationForm();
            });

            function addVariationForm() {
                var variationHtml = `
                    <div class="variation-form border p-3 mb-3">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label required">Attribute</label>
                                <select class="form-select attribute-select" required>
                                    <option value="">-- Select Attribute --</option>
                                    @foreach (var attr in ViewBag.Attributes)
                                    {
                                        <option value="@attr.AttributeID">@attr.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label required">Value</label>
                                <select class="form-select value-select" required>
                                    <option value="">-- Select Value --</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label required">Price</label>
                                <input type="number" class="form-control price-input" step="0.01" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label required">Stock Quantity</label>
                                <input type="number" class="form-control stock-input" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label required">Minimum Stock Level</label>
                                <input type="number" class="form-control minstock-input" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Image</label>
                                <input type="file" class="form-control variation-image" accept="image/*" />
                            </div>
                            <div class="col-12">
                                <button type="button" class="btn btn-success add-to-preview">
                                    <i class="bi bi-check-circle"></i> Add to Preview
                                </button>
                                <button type="button" class="btn btn-danger remove-variation">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                $('#variationsContainer').append(variationHtml);
            }

            // Handle attribute change in variation form
            $(document).on('change', '.attribute-select', function () {
                var attributeId = $(this).val();
                var valueSelect = $(this).closest('.variation-form').find('.value-select');
                
                if (attributeId) {
                    $.get('/Product/GetAttributeValues/' + attributeId, function (data) {
                        valueSelect.empty();
                        valueSelect.append('<option value="">-- Select Value --</option>');
                        $.each(data, function (index, item) {
                            valueSelect.append($('<option></option>').val(item.attributeValueID).text(item.value));
                        });
                    });
                }
            });

            // Handle add to preview button click
            $(document).on('click', '.add-to-preview', function () {
                var form = $(this).closest('.variation-form');
                var attribute = form.find('.attribute-select option:selected').text();
                var value = form.find('.value-select option:selected').text();
                var price = form.find('.price-input').val();
                var stock = form.find('.stock-input').val();
                var minStock = form.find('.minstock-input').val();

                var row = `
                    <tr>
                        <td>${attribute}</td>
                        <td>${value}</td>
                        <td>${price}</td>
                        <td>${stock}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger remove-preview">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                $('#variationsTable tbody').append(row);
            });

            // Handle remove variation button click
            $(document).on('click', '.remove-variation', function () {
                $(this).closest('.variation-form').remove();
            });

            // Handle remove preview button click
            $(document).on('click', '.remove-preview', function () {
                $(this).closest('tr').remove();
            });

            // Form validation
            $('#productForm').submit(function (e) {
                if ($('#productType').val() === 'variation' && $('#variationsTable tbody tr').length === 0) {
                    e.preventDefault();
                    toastr.error('Please add at least one variation');
                    return false;
                }
                return true;
            });
        });
    </script>
} 