USE [master]
GO
DROP DATABASE IF EXISTS [MansehraPaintHouse]
GO
CREATE DATABASE MansehraPaintHouse;
GO
USE MansehraPaintHouse;
GO

-- 1Ô∏è‚É£ Users & Authentication 
CREATE TABLE Users (
    UserID INT PRIMARY KEY IDENTITY(1,1),
    FullName VARCHAR(255) NOT NULL,
    Email VARCHAR(255) UNIQUE NOT NULL,
    PasswordHash VARCHAR(255) NOT NULL,
    Role VARCHAR(50) NOT NULL CHECK (Role IN ('Admin', 'Customer', 'Manager', 'Cashier', 'Supplier')) DEFAULT 'Customer',
    Phone VARCHAR(50),
    Address VARCHAR(MAX),
    CreatedAt DATETIME2 DEFAULT CURRENT_TIMESTAMP,
    IsActive BIT DEFAULT 1
);
GO

-- 2Ô∏è‚É£ Categories 
CREATE TABLE Categories (
    CategoryID INT PRIMARY KEY IDENTITY(1,1),
    ParentCategoryID INT NULL,
    Name VARCHAR(255) NOT NULL,
    Image1 VARCHAR(255),
    Image2 VARCHAR(255),
    Description VARCHAR(MAX),
    IsActive BIT DEFAULT 1,
    FOREIGN KEY (ParentCategoryID) REFERENCES Categories(CategoryID) ON DELETE NO ACTION
);
GO

-- 3Ô∏è‚É£ Products
CREATE TABLE Products (
    ProductID INT PRIMARY KEY IDENTITY(1,1),
    CategoryID INT NOT NULL,
    Name VARCHAR(255) NOT NULL,
    Description VARCHAR(MAX),
    Image VARCHAR(255),
    SKU VARCHAR(50) UNIQUE NOT NULL,
    Price DECIMAL(10,2) NOT NULL,
    StockQuantity INT DEFAULT 0,
    MinimumStockLevel INT DEFAULT 0,
    CreatedAt DATETIME2 DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME2 DEFAULT CURRENT_TIMESTAMP,
    IsActive BIT DEFAULT 1,
	IsVariationProduct BIT DEFAULT 0,
    FOREIGN KEY (CategoryID) REFERENCES Categories(CategoryID) ON DELETE CASCADE
);
GO

-- 4Ô∏è‚É£ Product Variations 
CREATE TABLE ProductVariations (
    VariationID INT PRIMARY KEY IDENTITY(1,1),
    ProductID INT NOT NULL,
    Description VARCHAR(MAX),
    Image VARCHAR(255),
    SKU VARCHAR(50) UNIQUE NOT NULL,
    Price DECIMAL(10,2) NOT NULL,
    StockQuantity INT DEFAULT 0,
    MinimumStockLevel INT DEFAULT 0,
    CreatedAt DATETIME2 DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME2 DEFAULT CURRENT_TIMESTAMP,
    IsActive BIT DEFAULT 1,
    FOREIGN KEY (ProductID) REFERENCES Products(ProductID) ON DELETE CASCADE
);
GO

-- 5Ô∏è‚É£ ProductAttributes & Attribute Values 
CREATE TABLE ProductAttributes (
    ProductAttributeID INT PRIMARY KEY IDENTITY(1,1),
    Name VARCHAR(255) UNIQUE NOT NULL,
	IsActive BIT DEFAULT 1
);
GO

CREATE TABLE AttributeValues (
    AttributeValueID INT PRIMARY KEY IDENTITY(1,1),
    ProductAttributeID INT NOT NULL, -- Updated reference
    Value VARCHAR(255) NOT NULL,
    Code VARCHAR(255),
    ColorCode VARCHAR(7),
	IsActive BIT DEFAULT 1,
    FOREIGN KEY (ProductAttributeID) REFERENCES ProductAttributes(ProductAttributeID) ON DELETE CASCADE
);
GO

-- 6Ô∏è‚É£ Product Variation Attributes 
CREATE TABLE ProductVariationAttributes (
    VariationAttributeID INT PRIMARY KEY IDENTITY(1,1),
    VariationID INT NOT NULL,
    ProductAttributeID INT NOT NULL, -- Updated reference
    AttributeValueID INT NOT NULL,
    FOREIGN KEY (VariationID) REFERENCES ProductVariations(VariationID) ON DELETE NO ACTION,
    FOREIGN KEY (ProductAttributeID) REFERENCES ProductAttributes(ProductAttributeID) ON DELETE NO ACTION,
    FOREIGN KEY (AttributeValueID) REFERENCES AttributeValues(AttributeValueID) ON DELETE NO ACTION
);
GO

-- 7Ô∏è‚É£ Warehouses & Inventory
CREATE TABLE Warehouses (
    WarehouseID INT PRIMARY KEY IDENTITY(1,1),
    Name VARCHAR(255) NOT NULL,
    Location VARCHAR(255) NOT NULL,
    IsActive BIT DEFAULT 1
);
GO

CREATE TABLE Inventory (
    InventoryID INT PRIMARY KEY IDENTITY(1,1),
    ProductID INT NOT NULL,
    WarehouseID INT NOT NULL,
    StockQuantity INT NOT NULL,
    LastUpdated DATETIME2 DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ProductID) REFERENCES Products(ProductID) ON DELETE CASCADE,
    FOREIGN KEY (WarehouseID) REFERENCES Warehouses(WarehouseID) ON DELETE CASCADE
);
GO

-- 8Ô∏è‚É£ Batch Tracking
CREATE TABLE BatchTracking (
    BatchID INT PRIMARY KEY IDENTITY(1,1),
    ProductID INT NOT NULL,
    WarehouseID INT NOT NULL,
    BatchNumber VARCHAR(50) NOT NULL UNIQUE,
    ExpiryDate DATE,
    StockQuantity INT NOT NULL,
    FOREIGN KEY (ProductID) REFERENCES Products(ProductID) ON DELETE CASCADE,
    FOREIGN KEY (WarehouseID) REFERENCES Warehouses(WarehouseID) ON DELETE CASCADE
);
GO

-- 9Ô∏è‚É£ Purchase Orders
CREATE TABLE PurchaseOrders (
    PurchaseOrderID INT PRIMARY KEY IDENTITY(1,1),
    UserID INT NULL,
    OrderDate DATETIME2 DEFAULT CURRENT_TIMESTAMP,
    Status VARCHAR(50) NOT NULL CHECK (Status IN ('Pending', 'Completed', 'Canceled')) DEFAULT 'Pending',
    TotalCost DECIMAL(10,2),
    FOREIGN KEY (UserID) REFERENCES Users(UserID) ON DELETE SET NULL
);
GO

CREATE TABLE PurchaseOrderItems (
    POItemID INT PRIMARY KEY IDENTITY(1,1),
    PurchaseOrderID INT NOT NULL,
    ProductID INT NOT NULL,
    Quantity INT NOT NULL,
    UnitCost DECIMAL(10,2),
    FOREIGN KEY (PurchaseOrderID) REFERENCES PurchaseOrders(PurchaseOrderID) ON DELETE CASCADE,
    FOREIGN KEY (ProductID) REFERENCES Products(ProductID) ON DELETE CASCADE
);
GO

-- üîü Orders
CREATE TABLE Orders (
    OrderID INT PRIMARY KEY IDENTITY(1,1),
    UserID INT,
    OrderDate DATETIME2 DEFAULT CURRENT_TIMESTAMP,
    Status VARCHAR(50) NOT NULL CHECK (Status IN ('Pending', 'Completed', 'Canceled')) DEFAULT 'Pending',
    TotalAmount DECIMAL(10,2),
    PaymentStatus VARCHAR(50) NOT NULL CHECK (PaymentStatus IN ('Pending', 'Paid', 'Refund')) DEFAULT 'Pending',
    FOREIGN KEY (UserID) REFERENCES Users(UserID) ON DELETE SET NULL
);
GO

CREATE TABLE OrderItems (
    OrderItemID INT PRIMARY KEY IDENTITY(1,1),
    OrderID INT NOT NULL,
    ProductID INT NOT NULL,
    Quantity INT NOT NULL,
    Price DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (OrderID) REFERENCES Orders(OrderID) ON DELETE CASCADE,
    FOREIGN KEY (ProductID) REFERENCES Products(ProductID) ON DELETE CASCADE
);
GO

-- 1Ô∏è‚É£1Ô∏è‚É£ Payments
CREATE TABLE Payments (
    PaymentID INT PRIMARY KEY IDENTITY(1,1),
    OrderID INT NOT NULL,
    PaymentDate DATETIME2 DEFAULT CURRENT_TIMESTAMP,
    Amount DECIMAL(10,2) NOT NULL,
    PaymentMethod VARCHAR(50) NOT NULL CHECK (PaymentMethod IN ('Cash', 'Card', 'Online', 'COD')) DEFAULT 'Cash',
    TransactionID VARCHAR(100) UNIQUE,
    FOREIGN KEY (OrderID) REFERENCES Orders(OrderID) ON DELETE CASCADE
);
GO

-- 1Ô∏è‚É£2Ô∏è‚É£ POS Transactions
CREATE TABLE POS_Transactions (
    TransactionID INT PRIMARY KEY IDENTITY(1,1),
    CashierID INT NOT NULL,
    OrderID INT NOT NULL,
    TransactionDate DATETIME2 DEFAULT CURRENT_TIMESTAMP,
    PaymentType VARCHAR(50) NOT NULL CHECK (PaymentType IN ('Cash', 'Card', 'Online')) DEFAULT 'Cash',
    TotalAmount DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (CashierID) REFERENCES Users(UserID) ON DELETE CASCADE,
    FOREIGN KEY (OrderID) REFERENCES Orders(OrderID) ON DELETE CASCADE
);
GO